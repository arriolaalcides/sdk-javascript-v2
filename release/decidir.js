"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),Decidir=function(){function e(t,r){_classCallCheck(this,e),t?this.apiUrl=t:this.apiUrl="https://live.decidir.com/api/v1",this.decidirValidator=new DecidirValidator,this.dontUseFraudPrevention=r,this.timeout=3e4}return _createClass(e,[{key:"setTimeout",value:function(e){e>=0&&(this.timeout=e)}},{key:"setPublishableKey",value:function(e){if(!e)throw new TypeError("publishableKey must be setted");this.publicKey=e,"undefined"!=typeof this.dontUseFraudPrevention&&this.dontUseFraudPrevention!==!1||this._initCyberSource()}},{key:"createToken",value:function(e,t){var r=this.collectFormData(e),a=this.decidirValidator.validateAll(r);a.isValid?(this.dontUseFraudPrevention||(r.fraud_detection={},r.fraud_detection.device_unique_identifier=this.device_unique_identifier),this.getHttp(this.timeout).post(this.apiUrl+"/tokens",r).then(function(e){t(e.status,e.data)},function(e){t(e.status,e.data)})):t(422,{error:a.errors})}},{key:"collectFormData",value:function(e){var t=e.querySelectorAll("[data-decidir]"),r={},a={};return Array.from(t).forEach(function(e){var t=e.getAttribute("data-decidir");t.lastIndexOf("card_holder_doc_")===-1?r[t]=e.value:a[t.replace("card_holder_doc_","")]=e.value}),""!==a.number&&(r.card_holder_identification=a),r}},{key:"getHttp",value:function(e){if(!this.publicKey)throw new TypeError("publishableKey must be setted");return new Http({contentType:"application/json",json:!0,headers:{apikey:this.publicKey}},e)}},{key:"getBin",value:function(e){return e.toString().replace(this.decidirValidator.cardNumbreReplaceRegExp,"").slice(0,6)}},{key:"_initCyberSource",value:function(){var e=this;this.getHttp(this.timeout).get(this.apiUrl+"/frauddetectionconf").then(function(t){if("undefined"!=typeof t.data&&t.data!=={}&&"undefined"!=typeof t.data.org_id&&""!==t.data.org_id){e.orgId=t.data.org_id,e.merchantId=t.data.merchant_id,e.device_unique_identifier=e._createUniqueIdentifier();var r=e.merchantId+e.device_unique_identifier;e._addCSHtml(r),e._addCSJs(r),e._addCSFlash(r)}})}},{key:"_addCSHtml",value:function(e){var t=document.createElement("p");t.setAttribute("style","background:url(https://h.online-metrix.net/fp/clear.png?org_id="+this.orgId+"&session_id="+e+"&m=1)"),t.style.display="none";var r=document.createElement("img");r.setAttribute("src","https://h.online-metrix.net/fp/clear.png?org_id="+this.orgId+"&session_id="+e+"&m=2"),r.style.display="none",document.body.appendChild(t),document.body.appendChild(r)}},{key:"_addCSJs",value:function(e){var t=document.createElement("script");t.setAttribute("text","text/javascript"),t.setAttribute("src","https://h.online-metrix.net/fp/check.js?org_id="+this.orgId+"&session_id="+e),document.body.appendChild(t)}},{key:"_addCSFlash",value:function(e){var t=document.createElement("object");t.setAttribute("type","application/x-shockwave-flash"),t.setAttribute("data","https://h.online-metrix.net/fp/fp.swf?org_id="+this.orgId+"&session_id="+e),t.setAttribute("width","1"),t.setAttribute("height","1"),t.setAttribute("id","thm_fp"),t.style.display="none";var r=document.createElement("param");r.setAttribute("name","movie"),r.setAttribute("value","https://h.online-metrix.net/fp/fp.swf?org_id="+this.orgId+"&session_id="+e),t.appendChild(r),document.body.appendChild(t)}},{key:"_createUniqueIdentifier",value:function(){return this._createUUID()}},{key:"_createUUID",value:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?r:3&r|8).toString(16)});return t}},{key:"validateCreditCardNumber",value:function(e){return this.decidirValidator.creditCardNumberValidator(e)}},{key:"validateExpiry",value:function(e,t){return this.decidirValidator.expiryDateValidator(e,t)}},{key:"validateSecurityCode",value:function(e){return this.decidirValidator.cvcValidator(e)}},{key:"validateCardHolderName",value:function(e){return this.decidirValidator.cardHolderNameValidator(e)}},{key:"cardType",value:function(e){return this.decidirValidator.getCardType(e)}}]),e}(),Http=function(){function e(t,r){_classCallCheck(this,e),this.events={READY_STATE_CHANGE:"readystatechange",LOAD_START:"loadstart",PROGRESS:"progress",ABORT:"abort",ERROR:"error",LOAD:"load",TIMEOUT:"timeout",LOAD_END:"loadend"},this.opts=t||{contentType:"application/json",json:!0},this.timeout=r>0?r:0,this.GET="GET",this.POST="POST",this.PUT="PUT",this.DELETE="DELETE"}return _createClass(e,[{key:"send",value:function(e,t,r){var a=this;return new Promise(function(i,n){var s=new XMLHttpRequest,d=t||a.GET;if(s.open(d,e),s.timeout=a.timeout,s.setRequestHeader("Content-Type",a.opts.contentType||"application/json"),a.opts.headers)for(var o in a.opts.headers)if(a.opts.headers.hasOwnProperty(o)){var u=a.opts.headers[o];s.setRequestHeader(o,u)}r=r?a.parseData(r):void 0,s.addEventListener(a.events.LOAD,function(){s.status>=200&&s.status<300||0===s.status?i(a.buildResponse(s)):n(a.buildResponse(s))}),s.addEventListener(a.events.ABORT,function(e){return n(a.buildResponse(s))}),s.addEventListener(a.events.ERROR,function(e){return n({status:503,statusText:"Service Unavailable"})}),s.addEventListener(a.events.TIMEOUT,function(e){return n({status:504,statusText:"Gateway Time-out"})}),r?s.send(r):s.send()})}},{key:"parseData",value:function(e){if("application/json"===this.opts.contentType)return JSON.stringify(e);var t=[];if("string"===("undefined"==typeof e?"undefined":_typeof(e)).toLowerCase()||"number"===("undefined"==typeof e?"undefined":_typeof(e)).toLowerCase())t.push(e);else for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")}},{key:"buildResponse",value:function(e){return{data:e.responseText?JSON.parse(e.responseText):void 0,status:e.status,headers:{},statusText:e.statusText}}},{key:"get",value:function(e){return this.send(e)}},{key:"post",value:function(e,t){return this.send(e,this.POST,t)}},{key:"put",value:function(e,t){return this.send(e,this.PUT,t)}},{key:"delete",value:function(e){return this.send(e,this.DELETE)}}]),e}(),DecidirValidator=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"validateAll",value:function(e){return void 0!==e.token?this.validateRequestWithTokenData(e):this.validateRequestWithCardData(e)}},{key:"validateRequestWithCardData",value:function(e){var t=[];t.push(this.creditCardNumberValidator(e.card_number)),t.push(this.expiryDateValidator(e.card_expiration_month,e.card_expiration_year)),t.push(this.cardHolderNameValidator(e.card_holder_name));var r=t.every(function(e){return e.isValid}),a=t.filter(function(e){return!e.isValid});return{isValid:r,errors:a}}},{key:"validateRequestWithTokenData",value:function(e){var t=[];t.push(this.cardTokenValidator(e.token));var r=t.every(function(e){return e.isValid}),a=t.filter(function(e){return!e.isValid});return{isValid:r,errors:a}}},{key:"creditCardNumberValidator",value:function(e){var t=this._defaultValidation("card_number",e);if(!t.isValid)return t;var r=this._validateLuhnAlgorithm(e.toString().replace(this.cardNumbreReplaceRegExp,""));return r.isValid||"naranja"!==this.getCardType(e)?r:this._validMessage("card_number")}},{key:"cardTokenValidator",value:function(e){var t=this._isEmpty("token",e);return t.isValid?this._validMessage("token"):t}},{key:"_validateLuhnAlgorithm",value:function(e){for(var t=void 0,r=0,a=0,i=e.length;i--;)t=parseInt(e.charAt(i),10)<<a,r+=t-9*(t>9),a^=1;return r%10===0&&r>0?this._validMessage("card_number"):this._createError("invalid","card_number")}},{key:"expiryDateValidator",value:function(e,t){var r=this._defaultValidation("expiry_date",e);if(!r.isValid)return r;var a=this._defaultValidation("expiry_date",t);if(!a.isValid)return a;var i=new Date,n=i.getFullYear()-2e3,s=i.getMonth()+1;return t<n||t==n&&e<s||e>12||e<1?this._createError("nan","expiry_date"):this._validMessage("expiry_date")}},{key:"cardHolderNameValidator",value:function(e){return this._isEmpty("card_holder_name",e)}},{key:"getCardType",value:function(e){var t=e.toString().replace(this.cardNumbreReplaceRegExp,""),r=this._issuingNetworks.find(function(e){return e.regEx.test(t)});return r?r.name:"other"}},{key:"_defaultValidation",value:function(e,t){var r=this._isEmpty(e,t);return r.isValid?this._numerRegexp.test(t)?this._validMessage(e):this._createError("nan",e):r}},{key:"_isEmpty",value:function(e,t){return t&&""!==t.toString().trim()?this._validMessage(e):this._createError("empty",e)}},{key:"_createError",value:function(e,t){return{isValid:!1,error:this._errors[e+t],param:t}}},{key:"_validMessage",value:function(e){return{isValid:!0,error:void 0,param:e}}},{key:"_errors",get:function(){return{emptycard_number:{type:"empty_card_number",message:"Card Number is empty",param:"card_number"},emptycard_holder_name:{type:"empty_card_holder_name",message:"Card Holder Name is empty",param:"card_holder_name"},nancard_number:{type:"nan_card_number",message:"Card Number must be a number",param:"card_number"},invalidcard_number:{type:"invalid_card_number",message:"Invalid Card Number",param:"card_number"},emptyexpiry_date:{type:"invalid_expiry_date",message:"Expiry date is invalid",param:"expiry_date"},nanexpiry_date:{type:"invalid_expiry_date",message:"Expiry date is invalid",param:"expiry_date"},emptytoken:{type:"empty_token",message:"Token is empty",param:"token"}}}},{key:"_issuingNetworks",get:function(){return[{name:"visa",regEx:/^4[0-9]{12}(?:[0-9]{3})?$/},{name:"mastercard",regEx:/^5[1-5][0-9]{14}$/},{name:"amex",regEx:/^3[47][0-9]{13}$/},{name:"Carte Blanche Card",regEx:/^389[0-9]{11}$/},{name:"discover",regEx:/^65[4-9][0-9]{13}|64[4-9][0-9]{13}|6011[0-9]{12}|(622(?:12[6-9]|1[3-9][0-9]|[2-8][0-9][0-9]|9[01][0-9]|92[0-5])[0-9]{10})$/},{name:"jcb",regEx:/^(?:2131|1800|35\d{3})\d{11}$/},{name:"visamaster",regEx:/^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14})$/},{name:"insta",regEx:/^63[7-9][0-9]{13}$/},{name:"laser",regEx:/^(6304|6706|6709|6771)[0-9]{12,15}$/},{name:"maestro",regEx:/^(5018|5020|5038|6304|6759|6761|6763)[0-9]{8,15}$/},{name:"solo",regEx:/^(6334|6767)[0-9]{12}|(6334|6767)[0-9]{14}|(6334|6767)[0-9]{15}$/},{name:"switch",regEx:/^(4903|4905|4911|4936|6333|6759)[0-9]{12}|(4903|4905|4911|4936|6333|6759)[0-9]{14}|(4903|4905|4911|4936|6333|6759)[0-9]{name: {15}|564182[0-9]{10}|564182[0-9]{12}|564182[0-9]{13}|633110[0-9]{10}|633110[0-9]{12}|633110[0-9]{13}$/},{name:"union",regEx:/^(62[0-9]{14,17})$/},{name:"korean",regEx:/^9[0-9]{15}$/},{name:"bcglobal",regEx:/^(6541|6556)[0-9]{12}$/},{name:"naranja",regEx:/^589562[0-9]{10}$/}]}},{key:"_numerRegexp",get:function(){return/\d+/}},{key:"cardNumbreReplaceRegExp",get:function(){return/[ .-]/g}}]),e}();